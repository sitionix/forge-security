name: Sync version from main to develop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-version-main
  cancel-in-progress: false

jobs:
  sync-version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Calculate versions
        id: versions
        run: python .github/scripts/version_helper.py export >> "$GITHUB_OUTPUT"

      - name: Check for existing sync PR
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GH_FORGE_SECURITY_TOKEN }}
          BRANCH_NAME: sync/release-${{ steps.versions.outputs.CURRENT_VERSION }}
        run: |
          existing_pr=$(gh pr list --head "${BRANCH_NAME}" --base develop --state open --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Found existing sync PR #${existing_pr}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure Git
        if: steps.check_pr.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        if: steps.check_pr.outputs.exists != 'true'
        env:
          BRANCH_NAME: sync/release-${{ steps.versions.outputs.CURRENT_VERSION }}
        run: git switch -c "${BRANCH_NAME}"

      - name: Bump project version
        if: steps.check_pr.outputs.exists != 'true'
        env:
          NEXT_VERSION: ${{ steps.versions.outputs.NEXT_VERSION }}
        run: mvn -B -ntp versions:set -DnewVersion=${NEXT_VERSION} -DgenerateBackupPoms=false

      - name: Commit changes
        if: steps.check_pr.outputs.exists != 'true'
        env:
          NEXT_VERSION: ${{ steps.versions.outputs.NEXT_VERSION }}
        run: |
          if git diff --quiet; then
            echo "No version changes detected." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          git commit -am "chore: bump version to ${NEXT_VERSION}"

      - name: Push sync branch
        if: steps.check_pr.outputs.exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_FORGE_SECURITY_TOKEN }}
          BRANCH_NAME: sync/release-${{ steps.versions.outputs.CURRENT_VERSION }}
        run: |
          git fetch origin "${BRANCH_NAME}" || true
          git push --force-with-lease origin "HEAD:${BRANCH_NAME}"

      - name: Open sync pull request
        if: steps.check_pr.outputs.exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_FORGE_SECURITY_TOKEN }}
          CURRENT_VERSION: ${{ steps.versions.outputs.CURRENT_VERSION }}
          NEXT_VERSION: ${{ steps.versions.outputs.NEXT_VERSION }}
          BRANCH_NAME: sync/release-${{ steps.versions.outputs.CURRENT_VERSION }}
        run: |
          gh pr create \
            --head "${BRANCH_NAME}" \
            --base develop \
            --title "Sync version ${CURRENT_VERSION} â†’ ${NEXT_VERSION}" \
            --body "This PR updates develop to version ${NEXT_VERSION} after merge into main."
